<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SYSTEM - Gym</title>
    
    <meta name="theme-color" content="#00ff9d">
    <link rel="manifest" href="manifest.json">

    <style>
        /* TEMA "THE SYSTEM" (Gym Edition) */
        :root { 
            --primary: #00ff9d; /* Verde Neon Sistema */
            --danger: #ff3333; 
            --gold: #ffd700;
            --bg: #050505; 
            --panel: #0f0f0f; 
            --border: #222; 
        }
        
        body { 
            background-color: var(--bg); color: white; 
            font-family: 'Courier New', monospace; 
            margin: 0; padding: 20px; padding-bottom: 90px;
            text-transform: uppercase;
        }
        
        /* HUD SUPERIOR */
        .hud-header { 
            border: 1px solid var(--primary); 
            padding: 15px; 
            margin-bottom: 20px; 
            background: rgba(0, 255, 157, 0.05);
            position: relative;
        }
        .hud-label { font-size: 0.6rem; color: var(--primary); letter-spacing: 2px; margin-bottom: 5px; }
        .hud-value { font-size: 1.2rem; font-weight: bold; color: white; letter-spacing: 1px; }
        .rank-badge { 
            position: absolute; right: 15px; top: 15px; 
            font-size: 2rem; color: var(--primary); font-weight: 900; 
            text-shadow: 0 0 10px var(--primary);
        }

        /* BARRA DE PROGRESSO (HIPERTROFIA) */
        .stat-box { margin-bottom: 30px; }
        .bar-container { width: 100%; height: 8px; background: #111; border: 1px solid #333; margin-top: 5px; }
        .bar-fill { height: 100%; background: var(--primary); width: 0%; box-shadow: 0 0 10px var(--primary); transition: width 0.5s ease; }

        /* SELETOR DE TREINO (GRID) */
        .workout-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .workout-btn {
            background: #111; border: 1px solid #333; padding: 20px 10px;
            text-align: center; cursor: pointer; transition: 0.2s;
        }
        .workout-btn:hover { border-color: var(--primary); background: #0a1a10; }
        .workout-btn:active { transform: scale(0.98); }
        .muscle-icon { font-size: 1.5rem; display: block; margin-bottom: 5px; }
        .muscle-name { font-size: 0.8rem; font-weight: bold; color: #ccc; }

        /* BOT√ÉO DE A√á√ÉO PRINCIPAL */
        .action-btn { 
            width: 100%; background: transparent; color: var(--primary); 
            font-family: 'Courier New', monospace; font-weight: bold; 
            border: 1px solid var(--primary); padding: 15px; cursor: pointer; 
            font-size: 1rem; transition: all 0.2s; margin-top: 10px;
        }
        .action-btn:hover { background: var(--primary); color: black; box-shadow: 0 0 15px var(--primary); }
        .action-btn:disabled { border-color: #444; color: #444; cursor: not-allowed; box-shadow: none; background: transparent; }

        /* CARD DE AFILIADO/AD (INTEGRADO AO SISTEMA) */
        .system-alert {
            border: 1px dashed var(--gold); padding: 15px; margin-top: 30px;
            background: rgba(255, 215, 0, 0.05); text-align: center;
        }

        /* NAVEGA√á√ÉO */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 70px;
            background: #000; border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 100;
        }
        .nav-item { text-align: center; color: #444; font-size: 0.7rem; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 1.4rem; display: block; margin-bottom: 2px; }

        /* MODAIS */
        .screen { display: none; }
        .screen.active { display: block; }
        
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:black; display:flex; align-items:center; justify-content:center; color:var(--primary); z-index:999; }
        
        #error-msg { display:none; color:red; font-size:0.7rem; margin-top:10px; text-align:center;}
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

    <div id="loading">CARREGANDO DADOS BIOM√âTRICOS...</div>
    <div id="error-msg"></div>

    <div id="screen-status" class="screen active">
        
        <div class="hud-header">
            <div class="hud-label">ATLETA</div>
            <div class="hud-value" id="playerName">...</div>
            
            <div style="margin-top: 15px;">
                <div class="hud-label">CLASSIFICA√á√ÉO ATUAL</div>
                <div class="hud-value" id="rankName" style="color:white">AN√ÅLISE...</div>
            </div>

            <div class="rank-badge" id="rankLetter">F</div>
        </div>

        <div class="stat-box">
            <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#888;">
                <span>PROGRESSO F√çSICO (XP)</span>
                <span id="xpText">0 / 1000</span>
            </div>
            <div class="bar-container">
                <div class="bar-fill" id="xpBar"></div>
            </div>
        </div>

        <div style="border-top: 1px solid #222; padding-top: 20px;">
            <div class="hud-label" style="margin-bottom: 15px;">INICIAR PROTOCOLO DE TREINO</div>
            
            <div class="workout-grid">
                <div class="workout-btn" onclick="selecionarTreino('PEITO/TRICEPS')">
                    <span class="muscle-icon">ü¶ç</span>
                    <span class="muscle-name">PUSH (EMPURRAR)</span>
                </div>
                <div class="workout-btn" onclick="selecionarTreino('COSTAS/BICEPS')">
                    <span class="muscle-icon">ü¶Ö</span>
                    <span class="muscle-name">PULL (PUXAR)</span>
                </div>
                <div class="workout-btn" onclick="selecionarTreino('PERNAS COMPLETO')">
                    <span class="muscle-icon">ü¶ñ</span>
                    <span class="muscle-name">LEGS (PERNAS)</span>
                </div>
                <div class="workout-btn" onclick="selecionarTreino('CARDIO/ABS')">
                    <span class="muscle-icon">‚ö°</span>
                    <span class="muscle-name">CARDIO / ABS</span>
                </div>
            </div>

            <button id="btnConfirmar" class="action-btn" disabled>SELECIONE UM PROTOCOLO</button>
        </div>

        <div class="system-alert" id="adBuffArea">
            <div style="color:var(--gold); font-weight:bold; font-size:0.9rem;">‚ö† SUPLEMENTA√á√ÉO DISPON√çVEL</div>
            <p style="font-size:0.7rem; color:#888;">Assista ao v√≠deo t√°tico para ganhar +20 XP extra.</p>
            <button class="action-btn" style="border-color:var(--gold); color:var(--gold); padding:10px;" onclick="ativarBuff()">RESGATAR BOOST</button>
        </div>

    </div>

    <div id="screen-shop" class="screen">
        <div class="hud-header">
            <div class="hud-label">MERCADO DO SISTEMA</div>
            <div class="hud-value">EQUIPAMENTOS</div>
        </div>

        <div class="workout-grid">
            <div class="workout-btn" onclick="abrirLink('https://amazon.com.br/creatina')">
                <span class="muscle-icon">üß™</span>
                <span class="muscle-name">CREATINA PURA</span>
                <span style="font-size:0.6rem; color:var(--gold)">R$ 89,90</span>
            </div>
            <div class="workout-btn" onclick="abrirLink('https://amazon.com.br/whey')">
                <span class="muscle-icon">ü•§</span>
                <span class="muscle-name">WHEY PROTEIN</span>
                <span style="font-size:0.6rem; color:var(--gold)">R$ 119,90</span>
            </div>
            <div class="workout-btn" onclick="abrirLink('https://amazon.com.br/pretreino')">
                <span class="muscle-icon">‚ò†Ô∏è</span>
                <span class="muscle-name">PR√â-TREINO</span>
                <span style="font-size:0.6rem; color:var(--gold)">R$ 79,90</span>
            </div>
             <div class="workout-btn" onclick="abrirLink('https://amazon.com.br/straps')">
                <span class="muscle-icon">üéóÔ∏è</span>
                <span class="muscle-name">STRAPS / LUVAS</span>
                <span style="font-size:0.6rem; color:var(--gold)">R$ 39,90</span>
            </div>
        </div>

        <div class="system-alert">
            <p style="font-size:0.7rem; color:#666;">
                *Adquirir itens aumenta seus atributos na vida real.<br>
                Links seguros de parceiros (Amazon/Growth).
            </p>
        </div>
    </div>

    <div id="screen-log" class="screen">
        <div class="hud-header">
            <div class="hud-label">HIST√ìRICO DE BATALHA</div>
            <div class="hud-value">LOGS</div>
        </div>
        <div id="logFeed" style="font-size:0.8rem; color:#aaa;">
            Carregando registros...
        </div>
        
        <button class="action-btn" onclick="auth.signOut().then(()=>location.reload())" style="border-color:var(--danger); color:var(--danger); margin-top:30px;">
            ENCERRAR SESS√ÉO
        </button>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="nav('status', this)">
            <span class="nav-icon">üìä</span>
            STATUS
        </div>
        <div class="nav-item" onclick="nav('shop', this)">
            <span class="nav-icon">üõí</span>
            LOJA
        </div>
        <div class="nav-item" onclick="nav('log', this)">
            <span class="nav-icon">üìú</span>
            LOGS
        </div>
    </div>

    <script>
        // TRATAMENTO DE ERROS
        window.onerror = function(msg) {
            document.getElementById('error-msg').style.display = 'block';
            document.getElementById('error-msg').innerText = "ERRO: " + msg;
        };

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyANh5g4EathHhB0cY4he_CTmdyLUm_TFuE",
            authDomain: "shapecoin.firebaseapp.com",
            projectId: "shapecoin",
            storageBucket: "shapecoin.firebasestorage.app",
            messagingSenderId: "365582210645",
            appId: "1:365582210645:web:8bf24f3809815340be66dc"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            let currentUser = null;
            let treinoSelecionado = "";

            // Limpa SW antigo
            if(navigator.serviceWorker) { navigator.serviceWorker.getRegistrations().then(r => r.forEach(i => i.unregister())); }

            auth.onAuthStateChanged((user) => {
                if (!user) window.location.href = "index.html";
                else { currentUser = user; initSystem(); }
            });

            // NAVEGA√á√ÉO
            window.nav = (screenId, elem) => {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                document.getElementById('screen-' + screenId).classList.add('active');
                elem.classList.add('active');
            }

            // SISTEMA DE RANKS (GYM EDITION)
            function getRank(xp) {
                if(xp < 1000) return { letter: "E", title: "FRANGO (INICIANTE)", next: 1000 };
                if(xp < 3000) return { letter: "D", title: "EM CONSTRU√á√ÉO", next: 3000 };
                if(xp < 6000) return { letter: "C", title: "PROJETO ATLETA", next: 6000 };
                if(xp < 10000) return { letter: "B", title: "SHAPE INEXPLIC√ÅVEL", next: 10000 };
                if(xp < 20000) return { letter: "A", title: "MUTANTE", next: 20000 };
                return { letter: "S", title: "LENDA DO OLYMPIA", next: 50000 };
            }

            function initSystem() {
                // 1. CARREGA DADOS DO ATLETA
                db.collection("users").doc(currentUser.uid).onSnapshot(doc => {
                    if (doc.exists) {
                        const d = doc.data();
                        const xp = d.coins || 0;
                        const nome = d.username || "Recruta";
                        const rank = getRank(xp);

                        document.getElementById('playerName').innerText = nome;
                        document.getElementById('rankLetter').innerText = rank.letter;
                        document.getElementById('rankName').innerText = rank.title;
                        
                        // Barra de XP
                        const pct = Math.min((xp / rank.next) * 100, 100);
                        document.getElementById('xpBar').style.width = pct + "%";
                        document.getElementById('xpText').innerText = `${xp} / ${rank.next} XP`;
                        
                        document.getElementById('loading').style.display = 'none';
                    } else {
                        // Perfil novo
                        db.collection("users").doc(currentUser.uid).set({ coins: 0, username: "Player" }, { merge: true });
                    }
                });

                // 2. CARREGA LOGS (Sem travar)
                db.collection("history")
                  .where("userId", "==", currentUser.uid)
                  .limit(10)
                  .onSnapshot(snap => {
                      const feed = document.getElementById('logFeed');
                      feed.innerHTML = "";
                      let logs = [];
                      snap.forEach(d => logs.push(d.data()));
                      logs.sort((a,b) => (b.date?.toMillis() || 0) - (a.date?.toMillis() || 0));

                      logs.forEach(l => {
                          const cor = l.type.includes("Buff") ? "var(--gold)" : "var(--primary)";
                          feed.innerHTML += `
                            <div style="border-left: 2px solid #333; padding-left: 10px; margin-bottom: 10px;">
                                <div style="color:white; font-size:0.7rem;">${l.type.toUpperCase()}</div>
                                <div style="color:${cor}; font-weight:bold;">+${l.value} XP</div>
                            </div>
                          `;
                      });
                  });
            }

            // SELE√á√ÉO DE TREINO
            window.selecionarTreino = (tipo) => {
                treinoSelecionado = tipo;
                // Visual feedback
                document.querySelectorAll('.workout-btn').forEach(b => b.style.borderColor = '#333');
                event.currentTarget.style.borderColor = 'var(--primary)';
                
                const btn = document.getElementById('btnConfirmar');
                btn.innerText = "CONFIRMAR: " + tipo;
                btn.disabled = false;
            }

            // CONFIRMAR TREINO
            document.getElementById('btnConfirmar').addEventListener('click', async () => {
                const btn = document.getElementById('btnConfirmar');
                btn.disabled = true;
                btn.innerText = "PROCESSANDO...";

                try {
                    await db.collection("history").add({
                        userId: currentUser.uid,
                        type: "Treino: " + treinoSelecionado,
                        value: 100,
                        date: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    await db.collection("users").doc(currentUser.uid).update({
                        coins: firebase.firestore.FieldValue.increment(100)
                    });
                    alert("TREINO REGISTRADO! +100 XP");
                } catch(e) { console.error(e); }

                btn.innerText = "TREINO CONCLU√çDO";
                setTimeout(() => { 
                    btn.innerText = "SELECIONE UM PROTOCOLO"; 
                    treinoSelecionado = "";
                }, 3000);
            });

            // ATIVAR BUFF (AD)
            window.ativarBuff = async () => {
                // Link do seu an√∫ncio
                window.open('https://otieu.com/4/10557860', '_blank');
                
                // D√° recompensa
                try {
                    await db.collection("history").add({
                        userId: currentUser.uid, type: "Buff de Sistema", value: 20,
                        date: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    await db.collection("users").doc(currentUser.uid).update({
                        coins: firebase.firestore.FieldValue.increment(20)
                    });
                } catch(e) { console.error(e); }
            }

            // LINK EXTERNO
            window.abrirLink = (url) => {
                // Futuramente coloque seus links de afiliado aqui
                window.open(url, '_blank');
            }

        } catch(e) {
            document.getElementById('error-msg').style.display = 'block';
            document.getElementById('error-msg').innerText = "FATAL: " + e.message;
        }
    </script>
</body>
</html>

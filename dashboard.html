<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOCUS | Atelier</title>
    
    <meta name="theme-color" content="#F2F0E9">
    <link rel="manifest" href="manifest.json">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        /* PALETA "QUIET LUXURY" (Off-White & Charcoal) */
        :root { 
            --bg: #F2F0E9; /* Off-White Quente (Papel Antigo) */
            --surface: #FFFFFF; /* Branco Puro */
            --text-main: #1A1A1A; /* Carv√£o */
            --text-muted: #888888; /* Cinza Suave */
            --accent: #E0DDD5; /* Bege para bordas */
            --black-btn: #111111; /* Bot√£o Preto Fosco */
            --shadow: rgba(0,0,0,0.04); /* Sombra ultra suave */
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            background-color: var(--bg); 
            color: var(--text-main); 
            font-family: 'Outfit', sans-serif; 
            margin: 0; padding: 30px; padding-bottom: 110px;
            overflow-x: hidden;
        }

        /* HEADER */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 50px;
        }
        .logo { 
            font-weight: 600; letter-spacing: 1px; font-size: 0.9rem; 
            text-transform: uppercase; color: var(--text-main);
        }
        .user-badge {
            font-size: 0.8rem; color: var(--text-muted); font-weight: 400;
            background: rgba(255,255,255,0.5); padding: 5px 12px; border-radius: 20px;
        }

        /* TIMER CENTRAL (C√≠rculo Limpo) */
        .timer-display {
            text-align: center; margin: 40px 0; position: relative;
        }
        /* C√≠rculo decorativo sutil */
        .timer-circle {
            width: 260px; height: 260px; margin: 0 auto;
            border-radius: 50%;
            background: var(--surface);
            box-shadow: 0 20px 60px var(--shadow);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            margin-bottom: 30px;
        }
        .main-time { 
            font-size: 3.2rem; font-weight: 300; color: var(--text-main); 
            letter-spacing: -2px; line-height: 1;
        }
        .time-label { 
            font-size: 0.75rem; color: var(--text-muted); 
            text-transform: uppercase; letter-spacing: 2px; margin-top: 10px;
        }

        /* PROGRESSO (Minimalista) */
        .xp-container { padding: 0 10px; margin-bottom: 50px; }
        .xp-info { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 12px; }
        .xp-track { width: 100%; height: 6px; background: #E5E5E5; border-radius: 10px; overflow: hidden; }
        .xp-fill { height: 100%; width: 0%; background: var(--text-main); border-radius: 10px; transition: width 1s ease; }

        /* BOT√ïES (P√≠lulas Arredondadas) */
        .btn-stack { display: flex; flex-direction: column; gap: 15px; }
        
        .btn {
            width: 100%; padding: 22px; border-radius: 100px;
            font-family: 'Outfit', sans-serif; font-weight: 500; font-size: 0.95rem;
            cursor: pointer; transition: transform 0.2s;
            border: none; display: flex; justify-content: center; align-items: center;
        }
        .btn:active { transform: scale(0.97); }

        /* Bot√£o Preto (Principal) */
        .btn-black { 
            background: var(--black-btn); color: #FFF; 
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
        }
        .btn-black:disabled { opacity: 0.3; cursor: not-allowed; box-shadow: none; }

        /* Bot√£o Outline (Secund√°rio) */
        .btn-outline { 
            background: transparent; color: var(--text-muted); 
            border: 1px solid #DDD;
        }
        .btn-outline:hover { border-color: var(--text-main); color: var(--text-main); }

        /* CARDS DA LOJA */
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .shop-card {
            background: var(--surface); padding: 30px 20px; border-radius: 24px;
            text-align: center; box-shadow: 0 10px 30px var(--shadow);
            transition: 0.3s; cursor: pointer;
        }
        .shop-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.08); }
        .shop-icon { font-size: 1.8rem; display: block; margin-bottom: 15px; opacity: 0.8; }
        .shop-name { font-size: 0.85rem; font-weight: 500; color: var(--text-main); }
        .shop-price { font-size: 0.7rem; color: var(--text-muted); margin-top: 5px; }

        /* LOGS (Hist√≥rico Limpo) */
        .log-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 18px 0; border-bottom: 1px solid #EAEAEA;
        }
        .log-type { font-size: 0.85rem; color: var(--text-main); }
        .log-date { font-size: 0.7rem; color: var(--text-muted); }
        .log-val { font-weight: 600; font-size: 0.85rem; }

        /* MENU FLUTUANTE (Dock Branco) */
        .dock {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: var(--surface); padding: 6px; border-radius: 100px;
            display: flex; gap: 5px; z-index: 100;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.02);
        }
        .dock-item {
            padding: 14px 28px; border-radius: 50px; cursor: pointer;
            color: var(--text-muted); font-size: 0.8rem; font-weight: 500; transition: 0.3s;
        }
        .dock-item.active { background: #F5F5F0; color: var(--text-main); font-weight: 600; }

        .screen { display: none; opacity: 0; transition: opacity 0.4s; }
        .screen.active { display: block; opacity: 1; }
        
        #loading { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: var(--bg); display:flex; align-items:center; justify-content:center; 
            color: var(--text-muted); z-index:999; font-size: 0.8rem; letter-spacing: 2px;
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

    <div id="loading">FOCUS OS</div>

    <div id="screen-focus" class="screen active">
        <div class="header">
            <div class="logo">FOCUS ‚Ä¢ OS</div>
            <div class="user-badge" id="userDisplay">Convidado</div>
        </div>

        <div class="timer-display">
            <div class="timer-circle">
                <div class="main-time" id="timerDisplay">00:00</div>
                <div class="time-label">Tempo Presente</div>
            </div>
        </div>

        <div class="xp-container">
            <div class="xp-info">
                <span>Estado de Fluxo</span>
                <span id="xpDisplay">0 XP</span>
            </div>
            <div class="xp-track"><div class="xp-fill" id="xpBar"></div></div>
        </div>

        <div class="btn-stack">
            <button id="btnClaim" class="btn btn-black" onclick="claimBonus()" disabled>
                Reivindicar Sess√£o (+100 XP)
            </button>

            <button id="btnReset" class="btn btn-outline" onclick="failProtocol()">
                Reiniciar Ciclo
            </button>
        </div>
    </div>

    <div id="screen-shop" class="screen">
        <div class="header">
            <div class="logo">CURADORIA</div>
            <div class="user-badge">Essenciais</div>
        </div>

        <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:30px; line-height:1.5;">
            Ferramentas selecionadas para maximizar sua clareza mental e produtividade.
        </p>

        <div class="shop-grid">
            <div class="shop-card" onclick="openLink('https://amazon.com.br/kindle')">
                <span class="shop-icon">üìñ</span>
                <div class="shop-name">Kindle Paperwhite</div>
                <div class="shop-price">Leitura Sem Distra√ß√£o</div>
            </div>
            <div class="shop-card" onclick="openLink('https://amazon.com.br/cafeina')">
                <span class="shop-icon">‚òï</span>
                <div class="shop-name">Nootr√≥picos</div>
                <div class="shop-price">Foco Limpo</div>
            </div>
            <div class="shop-card" onclick="openLink('https://amazon.com.br/bloqueadorazul')">
                <span class="shop-icon">üëì</span>
                <div class="shop-name">√ìculos Blue Light</div>
                <div class="shop-price">Prote√ß√£o Ocular</div>
            </div>
            <div class="shop-card" onclick="openLink('https://amazon.com.br/fones')">
                <span class="shop-icon">üéß</span>
                <div class="shop-name">Noise Cancelling</div>
                <div class="shop-price">Sil√™ncio Absoluto</div>
            </div>
        </div>
    </div>

    <div id="screen-log" class="screen">
        <div class="header">
            <div class="logo">REGISTROS</div>
            <div class="user-badge">Hist√≥rico</div>
        </div>

        <div id="logList" style="margin-top:20px;">
            <p style="text-align:center; color:var(--text-muted);">Sincronizando...</p>
        </div>

        <button class="btn btn-outline" onclick="logout()" style="margin-top:40px; border-color:#DDD; color:#AAA;">
            Desconectar
        </button>
    </div>

    <div class="dock">
        <div class="dock-item active" onclick="nav('focus', this)">Foco</div>
        <div class="dock-item" onclick="nav('shop', this)">Loja</div>
        <div class="dock-item" onclick="nav('log', this)">Dados</div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyANh5g4EathHhB0cY4he_CTmdyLUm_TFuE",
            authDomain: "shapecoin.firebaseapp.com",
            projectId: "shapecoin",
            storageBucket: "shapecoin.firebasestorage.app",
            messagingSenderId: "365582210645",
            appId: "1:365582210645:web:8bf24f3809815340be66dc"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            let currentUser = null;
            let lastResetTime = null;
            let timerInterval = null;

            if(navigator.serviceWorker) navigator.serviceWorker.getRegistrations().then(r => r.forEach(i => i.unregister()));

            auth.onAuthStateChanged((user) => {
                if (!user) window.location.href = "index.html";
                else { currentUser = user; initApp(); }
            });

            // NAV
            window.nav = (id, el) => {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.dock-item').forEach(i => i.classList.remove('active'));
                document.getElementById('screen-' + id).classList.add('active');
                el.classList.add('active');
            }

            function initApp() {
                db.collection("users").doc(currentUser.uid).onSnapshot(doc => {
                    if(doc.exists) {
                        const d = doc.data();
                        const xp = d.coins || 0;
                        document.getElementById('userDisplay').innerText = d.username || "Membro";
                        
                        // XP Bar
                        const target = 500;
                        const pct = Math.min((xp / target) * 100, 100);
                        document.getElementById('xpBar').style.width = pct + "%";
                        document.getElementById('xpDisplay').innerText = `${xp} XP`;

                        // Timer
                        if(d.lastReset) { lastResetTime = d.lastReset.toDate(); } 
                        else { lastResetTime = new Date(); db.collection("users").doc(currentUser.uid).update({ lastReset: firebase.firestore.FieldValue.serverTimestamp() }); }
                        
                        startTimer();
                        document.getElementById('loading').style.display = 'none';
                    } else {
                        db.collection("users").doc(currentUser.uid).set({ coins: 0, username: "Convidado", lastReset: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true});
                    }
                });

                // Logs
                db.collection("history").where("userId", "==", currentUser.uid).orderBy("date", "desc").limit(8).onSnapshot(snap => {
                    const list = document.getElementById('logList');
                    list.innerHTML = "";
                    snap.forEach(d => {
                        const val = d.data();
                        const date = val.date ? val.date.toDate().toLocaleDateString('pt-BR') : "-";
                        const isPos = val.value > 0;
                        list.innerHTML += `
                            <div class="log-item">
                                <div>
                                    <div class="log-type">${val.type}</div>
                                    <div class="log-date">${date}</div>
                                </div>
                                <div class="log-val" style="color: ${isPos ? '#1A1A1A' : '#999'}">
                                    ${isPos ? '+' : ''}${val.value}
                                </div>
                            </div>`;
                    });
                });
            }

            function startTimer() {
                if(timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    if(!lastResetTime) return;
                    const diff = new Date() - lastResetTime;
                    
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const hStr = hours.toString().padStart(2, '0');
                    const mStr = mins.toString().padStart(2, '0');
                    
                    document.getElementById('timerDisplay').innerText = `${hStr}:${mStr}`;

                    // L√≥gica 24h
                    const btnClaim = document.getElementById('btnClaim');
                    // TESTE: Mude 86400000 para 10000 para testar r√°pido
                    if(diff > 86400000) { 
                        btnClaim.disabled = false;
                        btnClaim.innerText = "Reivindicar Sess√£o (+100 XP)";
                    } else {
                        btnClaim.disabled = true;
                    }
                }, 1000);
            }

            // A√á√ïES COM ADS
            window.failProtocol = async () => {
                if(!confirm("Deseja realmente reiniciar seu ciclo de foco?")) return;
                window.open('https://otieu.com/4/10557860', '_blank'); // AD
                try {
                    await db.collection("users").doc(currentUser.uid).update({ lastReset: firebase.firestore.FieldValue.serverTimestamp() });
                    await db.collection("history").add({
                        userId: currentUser.uid, type: "Rein√≠cio", value: 0,
                        date: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch(e) { console.error(e); }
            }

            window.claimBonus = async () => {
                window.open('https://otieu.com/4/10557860', '_blank'); // AD
                const btn = document.getElementById('btnClaim');
                btn.innerText = "Sincronizando..."; btn.disabled = true;
                try {
                    await db.collection("users").doc(currentUser.uid).update({ coins: firebase.firestore.FieldValue.increment(100) });
                    await db.collection("history").add({
                        userId: currentUser.uid, type: "Sess√£o Completa", value: 100,
                        date: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert("Sess√£o registrada com sucesso.");
                } catch(e) { console.error(e); }
            }

            window.openLink = (url) => window.open(url, '_blank');
            window.logout = () => auth.signOut().then(() => window.location.reload());
        } catch(e) { alert("Erro: " + e.message); }
    </script>
</body>
</html>

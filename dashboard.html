<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOCUS | OS</title>
    
    <meta name="theme-color" content="#050505">
    <link rel="manifest" href="manifest.json">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        /* TEMA "QUIET LUXURY" */
        :root { 
            --bg: #050505; 
            --card: #121212; 
            --text-main: #F2F2F2;
            --text-muted: #666666;
            --accent: #FFFFFF; /* Branco Puro para destaque */
            --border: #222222;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            background-color: var(--bg); 
            color: var(--text-main); 
            font-family: 'Outfit', sans-serif; 
            margin: 0; padding: 25px; padding-bottom: 100px;
            overflow-x: hidden;
        }

        /* HEADER MINIMALISTA */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 40px; padding-top: 10px;
        }
        .app-logo { font-weight: 700; letter-spacing: 2px; font-size: 0.9rem; color: var(--text-muted); }
        .user-chip { 
            background: var(--card); border: 1px solid var(--border); 
            padding: 8px 16px; border-radius: 50px; 
            font-size: 0.8rem; color: var(--text-main); font-weight: 500;
        }

        /* TIMER CENTRAL (Eleg√¢ncia Pura) */
        .timer-wrapper {
            text-align: center; margin: 50px 0;
            position: relative;
        }
        .timer-ring {
            width: 280px; height: 280px; margin: 0 auto;
            border-radius: 50%;
            border: 1px solid var(--border);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: radial-gradient(circle, #0a0a0a 0%, #050505 70%);
            box-shadow: 0 0 40px rgba(255,255,255,0.02);
        }
        .timer-val { font-size: 3.5rem; font-weight: 300; letter-spacing: -2px; color: var(--text-main); line-height: 1; }
        .timer-label { font-size: 0.75rem; color: var(--text-muted); margin-top: 10px; letter-spacing: 1px; text-transform: uppercase;}

        /* BARRA DE PROGRESSO SUTIL */
        .progress-container { margin: 40px 0; }
        .progress-info { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 10px; }
        .progress-bg { width: 100%; height: 4px; background: var(--border); border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: var(--accent); border-radius: 10px; transition: width 1s ease; }

        /* BOT√ïES REDONDOS E PREMIUM */
        .action-grid { display: grid; gap: 15px; }
        
        .btn {
            width: 100%; padding: 22px; border-radius: 100px;
            font-family: 'Outfit', sans-serif; font-weight: 500; font-size: 0.95rem;
            cursor: pointer; transition: transform 0.2s, opacity 0.2s;
            border: none; display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .btn:active { transform: scale(0.98); }
        
        /* Bot√£o Principal (Branco) */
        .btn-primary { 
            background: var(--accent); color: #000; 
            box-shadow: 0 10px 30px rgba(255,255,255,0.1);
        }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }

        /* Bot√£o Secund√°rio (Outline/Ghost) - Para Falha */
        .btn-ghost { 
            background: transparent; color: var(--text-muted); 
            border: 1px solid var(--border);
        }
        .btn-ghost:hover { border-color: #444; color: #fff; }

        /* CARDS DA LOJA */
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .shop-card {
            background: var(--card); border-radius: 24px; padding: 25px 15px;
            text-align: center; border: 1px solid transparent; transition: 0.3s;
        }
        .shop-card:hover { border-color: #333; transform: translateY(-3px); }
        .shop-icon { font-size: 1.8rem; display: block; margin-bottom: 15px; opacity: 0.8; }
        .shop-title { font-size: 0.85rem; color: var(--text-main); font-weight: 500; display: block; }
        .shop-sub { font-size: 0.7rem; color: var(--text-muted); margin-top: 5px; display: block; }

        /* LOGS LIMPOS */
        .log-list { margin-top: 20px; }
        .log-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 0; border-bottom: 1px solid var(--border);
            font-size: 0.85rem; color: var(--text-muted);
        }
        .log-val { color: var(--text-main); font-weight: 500; }

        /* NAVEGA√á√ÉO FLUTUANTE (DOCK) */
        .dock-nav {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(20px);
            padding: 8px 10px; border-radius: 100px;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; gap: 5px; z-index: 100;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }
        .nav-pill {
            padding: 12px 24px; border-radius: 50px; cursor: pointer;
            color: #666; font-size: 0.8rem; font-weight: 500; transition: 0.3s;
        }
        .nav-pill.active { background: #fff; color: #000; }
        
        /* UTILIT√ÅRIOS */
        .screen { display: none; animation: fadeUp 0.4s ease; }
        .screen.active { display: block; }
        @keyframes fadeUp { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
        
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); display:flex; align-items:center; justify-content:center; color:var(--text-muted); z-index:999; font-size: 0.8rem; letter-spacing: 2px;}
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

    <div id="loading">CARREGANDO...</div>

    <div id="screen-focus" class="screen active">
        <div class="header">
            <div class="app-logo">FOCUS ‚Ä¢ OS</div>
            <div class="user-chip" id="userDisplay">...</div>
        </div>

        <div class="timer-wrapper">
            <div class="timer-ring">
                <div class="timer-val" id="timerDisplay">00:00</div>
                <div class="timer-label">Tempo em Foco</div>
            </div>
        </div>

        <div class="progress-container">
            <div class="progress-info">
                <span>N√≠vel de Clareza</span>
                <span id="xpDisplay">0 / 500</span>
            </div>
            <div class="progress-bg">
                <div class="progress-fill" id="xpBar"></div>
            </div>
        </div>

        <div class="action-grid">
            <button id="btnClaim" class="btn btn-primary" onclick="claimBonus()" disabled>
                <span>Resgatar Consci√™ncia</span>
                <span style="opacity:0.5; font-size:0.7rem;">(+100 XP)</span>
            </button>

            <button id="btnReset" class="btn btn-ghost" onclick="failProtocol()">
                Reiniciar Ciclo
            </button>
        </div>
    </div>

    <div id="screen-shop" class="screen">
        <div class="header">
            <div class="app-logo">ESSENCIAIS</div>
            <div class="user-chip">Loja</div>
        </div>
        
        <p style="color:#666; font-size:0.9rem; margin-bottom:20px;">Ferramentas curadas para maximizar seu desempenho cognitivo.</p>

        <div class="shop-grid">
            <div class="shop-card" onclick="openLink('https://amazon.com.br/kindle')">
                <span class="shop-icon">üìñ</span>
                <span class="shop-title">Kindle</span>
                <span class="shop-sub">Leitura Profunda</span>
            </div>
            <div class="shop-card" onclick="openLink('https://amazon.com.br/cafeina')">
                <span class="shop-icon">‚òï</span>
                <span class="shop-title">Nootr√≥picos</span>
                <span class="shop-sub">Energia Limpa</span>
            </div>
            <div class="shop-card" onclick="openLink('https://amazon.com.br/bloqueadorazul')">
                <span class="shop-icon">üëì</span>
                <span class="shop-title">Blue Light</span>
                <span class="shop-sub">Prote√ß√£o Ocular</span>
            </div>
            <div class="shop-card" onclick="openLink('https://amazon.com.br/fones')">
                <span class="shop-icon">üéß</span>
                <span class="shop-title">Sil√™ncio</span>
                <span class="shop-sub">Cancelamento de Ru√≠do</span>
            </div>
        </div>
    </div>

    <div id="screen-log" class="screen">
        <div class="header">
            <div class="app-logo">JORNADA</div>
            <div class="user-chip">Hist√≥rico</div>
        </div>

        <div id="logList" class="log-list">
            <div style="text-align:center; color:#444; margin-top:50px;">Carregando dados...</div>
        </div>

        <button class="btn btn-ghost" onclick="logout()" style="margin-top:40px; border-color: rgba(255,0,0,0.2); color: #888;">
            Desconectar
        </button>
    </div>

    <div class="dock-nav">
        <div class="nav-pill active" onclick="nav('focus', this)">Foco</div>
        <div class="nav-pill" onclick="nav('shop', this)">Shop</div>
        <div class="nav-pill" onclick="nav('log', this)">Dados</div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyANh5g4EathHhB0cY4he_CTmdyLUm_TFuE",
            authDomain: "shapecoin.firebaseapp.com",
            projectId: "shapecoin",
            storageBucket: "shapecoin.firebasestorage.app",
            messagingSenderId: "365582210645",
            appId: "1:365582210645:web:8bf24f3809815340be66dc"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            let currentUser = null;
            let lastResetTime = null;
            let timerInterval = null;

            if(navigator.serviceWorker) navigator.serviceWorker.getRegistrations().then(r => r.forEach(i => i.unregister()));

            auth.onAuthStateChanged((user) => {
                if (!user) window.location.href = "index.html";
                else { currentUser = user; initApp(); }
            });

            // NAV
            window.nav = (id, el) => {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.nav-pill').forEach(i => i.classList.remove('active'));
                document.getElementById('screen-' + id).classList.add('active');
                el.classList.add('active');
            }

            function initApp() {
                db.collection("users").doc(currentUser.uid).onSnapshot(doc => {
                    if(doc.exists) {
                        const d = doc.data();
                        const xp = d.coins || 0;
                        
                        document.getElementById('userDisplay').innerText = d.username || "Membro";
                        
                        // XP Bar
                        const target = 500; // Meta fixa para visual
                        const pct = Math.min((xp / target) * 100, 100);
                        document.getElementById('xpBar').style.width = pct + "%";
                        document.getElementById('xpDisplay').innerText = `${xp} pts`;

                        // Timer
                        if(d.lastReset) {
                            lastResetTime = d.lastReset.toDate();
                        } else {
                            lastResetTime = new Date();
                            db.collection("users").doc(currentUser.uid).update({ lastReset: firebase.firestore.FieldValue.serverTimestamp() });
                        }
                        
                        startTimer();
                        document.getElementById('loading').style.display = 'none';
                    } else {
                        db.collection("users").doc(currentUser.uid).set({ coins: 0, username: "Convidado", lastReset: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true});
                    }
                });

                // Logs (Clean)
                db.collection("history").where("userId", "==", currentUser.uid).orderBy("date", "desc").limit(8).onSnapshot(snap => {
                    const list = document.getElementById('logList');
                    list.innerHTML = "";
                    if(snap.empty) {
                        list.innerHTML = "<div style='text-align:center; color:#444; margin-top:20px;'>Nenhum registro ainda.</div>";
                        return;
                    }
                    snap.forEach(d => {
                        const val = d.data();
                        const date = val.date ? val.date.toDate().toLocaleDateString('pt-BR') : "-";
                        const isGood = val.value > 0;
                        list.innerHTML += `
                            <div class="log-item">
                                <div>
                                    <div style="color:var(--text-main); margin-bottom:2px;">${val.type}</div>
                                    <div style="font-size:0.7rem; opacity:0.6;">${date}</div>
                                </div>
                                <div class="log-val" style="color: ${isGood ? '#fff' : '#666'}">
                                    ${isGood ? '+' : ''}${val.value}
                                </div>
                            </div>`;
                    });
                });
            }

            function startTimer() {
                if(timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    if(!lastResetTime) return;
                    const diff = new Date() - lastResetTime;
                    
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    // Simplificado para H:MM para ser mais elegante
                    const hStr = hours.toString().padStart(2, '0');
                    const mStr = mins.toString().padStart(2, '0');
                    
                    document.getElementById('timerDisplay').innerText = `${hStr}:${mStr}`;

                    // Bot√£o Claim ativa ap√≥s 24h
                    const btnClaim = document.getElementById('btnClaim');
                    // TESTE: Mude 86400000 para 10000 (10 seg) para testar agora
                    if(diff > 86400000) { 
                        btnClaim.disabled = false;
                        btnClaim.innerHTML = "<span>Resgatar Consci√™ncia</span>";
                    } else {
                        btnClaim.disabled = true;
                        // Mostra quanto falta se quiser, ou deixa est√°tico
                    }
                }, 1000);
            }

            // A√á√ïES
            window.failProtocol = async () => {
                if(!confirm("Reiniciar seu ciclo de foco?")) return;
                
                // AD PUNITIVO
                window.open('https://otieu.com/4/10557860', '_blank');

                try {
                    await db.collection("users").doc(currentUser.uid).update({ lastReset: firebase.firestore.FieldValue.serverTimestamp() });
                    await db.collection("history").add({
                        userId: currentUser.uid, type: "Rein√≠cio de Ciclo", value: 0,
                        date: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch(e) { console.error(e); }
            }

            window.claimBonus = async () => {
                const btn = document.getElementById('btnClaim');
                
                // AD RECOMPENSA
                window.open('https://otieu.com/4/10557860', '_blank');

                btn.innerText = "Processando..."; btn.disabled = true;
                try {
                    await db.collection("users").doc(currentUser.uid).update({ coins: firebase.firestore.FieldValue.increment(100) });
                    await db.collection("history").add({
                        userId: currentUser.uid, type: "Ciclo Completo", value: 100,
                        date: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert("Foco recompensado.");
                } catch(e) { console.error(e); }
            }

            window.openLink = (url) => window.open(url, '_blank');
            window.logout = () => auth.signOut().then(() => window.location.reload());
        } catch(e) { alert("Erro: " + e.message); }
    </script>
</body>
</html>

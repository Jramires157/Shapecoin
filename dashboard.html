<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOCO - Modo Seguro</title>
    
    <style>
        /* TEMA EST√ÅVEL (Sem efeitos pesados) */
        body { 
            background-color: #000000; 
            color: white; 
            font-family: sans-serif; 
            margin: 0; 
            padding: 20px; 
            padding-bottom: 100px;
        }

        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .user-info h2 { margin: 0; font-size: 1.2rem; color: #00ff9d; }
        .coin-badge { background: #ffd700; color: black; padding: 5px 15px; border-radius: 20px; font-weight: bold; }

        /* CART√ïES S√ìLIDOS (Para n√£o dar tela preta) */
        .card { 
            background-color: #1a1a1a; /* Cinza S√≥lido */
            border: 1px solid #333; 
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px; 
        }

        h3 { color: #888; border-bottom: 1px solid #333; padding-bottom: 10px; margin-top: 0; font-size: 0.9rem; text-transform: uppercase; }

        /* BOT√ÉO TREINO */
        #btnTreinar {
            width: 100%;
            padding: 20px;
            background-color: #00ff9d;
            color: black;
            border: none;
            font-weight: bold;
            font-size: 1.1rem;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 10px;
        }

        /* INPUTS */
        input { 
            width: 100%; padding: 15px; margin: 5px 0 15px 0; 
            background: #333; border: 1px solid #555; color: white; border-radius: 8px; box-sizing: border-box; 
        }

        /* MURAL SIMPLES */
        .feed-post { 
            background: #111; border: 1px solid #222; 
            padding: 10px; margin-bottom: 10px; border-radius: 8px; 
            display: flex; justify-content: space-between;
        }

        /* CAIXA DE ERRO (S√≥ aparece se der ruim) */
        #error-box {
            display: none;
            background: #ff0000;
            color: white;
            padding: 20px;
            position: fixed;
            top: 0; left: 0; width: 100%;
            z-index: 9999;
            font-weight: bold;
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

    <div id="error-box">Erro detectado: <span id="error-msg"></span></div>

    <div class="header">
        <div class="user-info" onclick="toggleMenu()">
            <span style="color:#666; font-size: 12px;">ATLETA</span>
            <h2 id="displayUsername">Carregando... ‚öôÔ∏è</h2>
        </div>
        <div class="coin-badge">üíé <span id="coinBalance">0</span></div>
    </div>

    <div class="card" id="cardIdentity" style="display: none;">
        <h3>Editar Perfil</h3>
        <label>Seu @usuario</label>
        <input type="text" id="username" placeholder="Ex: @joao">
        
        <label>Peso (kg)</label>
        <input type="text" id="weight">
        
        <label>Altura (cm)</label>
        <input type="text" id="height">
        
        <button onclick="salvarPerfil()" style="width:100%; padding:15px; background:#333; color:white; border:none; border-radius:8px;">SALVAR</button>
        <br><br>
        <button onclick="sair()" style="width:100%; padding:10px; background:red; color:white; border:none; border-radius:8px;">SAIR DA CONTA</button>
    </div>

    <div class="card">
        <h3 style="color:#00ff9d;">Check-in Hoje</h3>
        <p style="color:#aaa;">Foco no processo.</p>
        <button id="btnTreinar">CONFIRMAR (+50 FC)</button>
    </div>

    <div id="focoFeed">
        <h3>Mural</h3>
        <p style="color:#666; text-align:center;">Carregando...</p>
    </div>

    <script>
        // 1. CAPTURADOR DE ERROS GLOBAL
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('error-box').style.display = 'block';
            document.getElementById('error-msg').innerText = message;
        };

        const firebaseConfig = {
            apiKey: "AIzaSyANh5g4EathHhB0cY4he_CTmdyLUm_TFuE",
            authDomain: "shapecoin.firebaseapp.com",
            projectId: "shapecoin",
            storageBucket: "shapecoin.firebasestorage.app",
            messagingSenderId: "365582210645",
            appId: "1:365582210645:web:8bf24f3809815340be66dc"
        };

        // INICIANDO
        try {
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            let currentUser = null;

            auth.onAuthStateChanged((user) => {
                if (!user) window.location.href = "index.html";
                else {
                    currentUser = user;
                    carregarDados();
                }
            });

            // FUN√á√ïES
            window.toggleMenu = function() {
                const x = document.getElementById("cardIdentity");
                x.style.display = (x.style.display === "none") ? "block" : "none";
            }

            window.sair = function() {
                auth.signOut().then(() => window.location.href = "index.html");
            }

            window.salvarPerfil = function() {
                const nome = document.getElementById('username').value;
                const peso = document.getElementById('weight').value;
                const altura = document.getElementById('height').value;

                if(!nome) return alert("Coloque um nome!");

                db.collection("users").doc(currentUser.uid).set({
                    username: nome.replace('@', ''),
                    weight: parseFloat(peso) || 0,
                    height: parseFloat(altura) || 0
                }, { merge: true }).then(() => {
                    alert("Salvo!");
                    toggleMenu();
                }).catch(e => alert("Erro: " + e.message));
            }

            // BOT√ÉO TREINAR (CHECK-IN)
            document.getElementById('btnTreinar').addEventListener('click', function() {
                const btn = document.getElementById('btnTreinar');
                const userText = document.getElementById('displayUsername').innerText;

                if(userText.includes("Carregando") || userText.includes("Configurar")) {
                    toggleMenu();
                    return alert("Configure seu perfil primeiro!");
                }

                btn.disabled = true;
                btn.innerText = "REGISTRANDO...";

                // Pega nome atualizado
                db.collection("users").doc(currentUser.uid).get().then(doc => {
                    const myName = doc.data().username || "Atleta";
                    
                    // Salva hist√≥rico
                    db.collection("history").add({
                        userId: currentUser.uid,
                        username: myName,
                        type: "Check-in",
                        value: 50,
                        date: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Paga
                    db.collection("users").doc(currentUser.uid).update({
                        coins: firebase.firestore.FieldValue.increment(50)
                    }).then(() => {
                        alert("CHECK-IN FEITO!");
                        btn.disabled = false;
                        btn.innerText = "CONFIRMAR (+50 FC)";
                    });
                });
            });

            function carregarDados() {
                db.collection("users").doc(currentUser.uid).onSnapshot(doc => {
                    if (doc.exists) {
                        const d = doc.data();
                        document.getElementById('coinBalance').innerText = d.coins || 0;
                        
                        if(d.username) {
                            document.getElementById('displayUsername').innerText = "@" + d.username + " ‚öôÔ∏è";
                            document.getElementById('username').value = d.username;
                        } else {
                            document.getElementById('displayUsername').innerText = "Configurar Perfil ‚öôÔ∏è";
                        }
                        
                        if(d.weight) document.getElementById('weight').value = d.weight;
                        if(d.height) document.getElementById('height').value = d.height;
                    }
                });

                db.collection("history").orderBy("date", "desc").limit(10).onSnapshot(snap => {
                    const div = document.getElementById('focoFeed');
                    div.innerHTML = "<h3>Mural</h3>";
                    snap.forEach(doc => {
                        const d = doc.data();
                        div.innerHTML += `<div class="feed-post"><span>@${d.username || 'Atleta'}</span> <span style="color:#ffd700">+${d.value}</span></div>`;
                    });
                });
            }

        } catch (e) {
            alert("Erro cr√≠tico: " + e.message);
        }
    </script>
</body>
</html>

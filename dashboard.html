<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROTOCOL: FOCUS</title>
    
    <meta name="theme-color" content="#00ff9d">
    <link rel="manifest" href="manifest.json">

    <style>
        /* TEMA "CYBERPUNK INDUSTRIAL" */
        :root { 
            --primary: #00ff9d; 
            --primary-dim: rgba(0, 255, 157, 0.1);
            --alert: #ff2a2a;
            --bg: #050505; 
            --panel: #0a0a0a; 
            --border: #222; 
        }
        
        body { 
            background-color: var(--bg); 
            color: white; 
            font-family: 'Courier New', monospace; 
            margin: 0; padding: 20px; padding-bottom: 90px;
            text-transform: uppercase; user-select: none;
            background-image: linear-gradient(0deg, #050505 50%, #080808 50%);
            background-size: 100% 4px; /* Efeito Scanline */
            min-height: 100vh;
        }

        /* HEADER */
        .header {
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px; margin-bottom: 30px;
            display: flex; justify-content: space-between; align-items: flex-end;
        }
        .user-label { font-size: 0.6rem; color: #666; letter-spacing: 2px; }
        .user-val { font-size: 1rem; color: var(--primary); font-weight: bold; text-shadow: 0 0 10px var(--primary-dim); }

        /* O TIMER GIGANTE */
        .timer-container {
            text-align: center; margin: 40px 0;
            position: relative;
        }
        .timer-label { font-size: 0.7rem; color: #888; letter-spacing: 4px; margin-bottom: 10px; }
        .main-timer {
            font-size: 3.5rem; font-weight: 900; color: white;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
            line-height: 1; letter-spacing: -2px;
        }
        .timer-unit { font-size: 0.8rem; color: #444; margin-top: 5px; }

        /* XP BAR */
        .xp-box { margin-bottom: 40px; }
        .xp-header { display: flex; justify-content: space-between; font-size: 0.6rem; color: #666; margin-bottom: 5px; }
        .xp-track { width: 100%; height: 4px; background: #111; border-radius: 2px; overflow: hidden; }
        .xp-fill { height: 100%; width: 0%; background: var(--primary); box-shadow: 0 0 10px var(--primary); transition: width 0.5s ease; }

        /* BOT√ïES DE A√á√ÉO */
        .btn-grid { display: grid; gap: 15px; margin-bottom: 40px; }
        
        .btn-action {
            width: 100%; background: transparent; 
            padding: 20px; cursor: pointer; border-radius: 4px;
            font-family: 'Courier New', monospace; font-weight: bold; font-size: 0.9rem;
            transition: 0.2s; position: relative; overflow: hidden;
        }

        /* Bot√£o Recompensa (Verde) */
        .btn-claim {
            border: 1px solid var(--primary); color: var(--primary);
        }
        .btn-claim:hover { background: var(--primary-dim); box-shadow: 0 0 20px var(--primary-dim); }
        .btn-claim:disabled { border-color: #333; color: #333; cursor: not-allowed; box-shadow: none; }

        /* Bot√£o Falha (Vermelho) */
        .btn-fail {
            border: 1px solid var(--alert); color: var(--alert);
        }
        .btn-fail:hover { background: rgba(255, 42, 42, 0.1); box-shadow: 0 0 20px rgba(255, 42, 42, 0.1); }

        /* LOJA (ARSENAL) */
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .shop-item {
            background: #0a0a0a; border: 1px solid #222; padding: 15px; text-align: center;
            cursor: pointer; transition: 0.2s;
        }
        .shop-item:hover { border-color: white; }
        .shop-icon { font-size: 1.5rem; display: block; margin-bottom: 10px; }
        .shop-name { font-size: 0.7rem; color: #888; }
        
        /* LOGS */
        .log-entry { 
            border-left: 2px solid #333; padding-left: 10px; margin-bottom: 10px; 
            font-size: 0.7rem; color: #666; 
        }

        /* NAV */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 70px;
            background: rgba(5,5,5,0.95); border-top: 1px solid #222;
            display: flex; justify-content: space-around; align-items: center; z-index: 100;
            backdrop-filter: blur(5px);
        }
        .nav-item { color: #444; font-size: 0.7rem; cursor: pointer; text-align: center; }
        .nav-item.active { color: white; text-shadow: 0 0 10px white; }
        .nav-icon { font-size: 1.4rem; display: block; margin-bottom: 3px; }

        .screen { display: none; animation: fadeIn 0.3s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
        
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:black; display:flex; align-items:center; justify-content:center; color:white; z-index:999; flex-direction:column; gap:10px; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

    <div id="loading">
        <div style="letter-spacing: 3px;">PROTOCOL: FOCUS</div>
        <div style="font-size:0.7rem; color:#666;">SINCRONIZANDO...</div>
    </div>

    <div id="screen-focus" class="screen active">
        <div class="header">
            <div>
                <div class="user-label">OPERADOR</div>
                <div class="user-val" id="playerName">...</div>
            </div>
            <div style="text-align: right;">
                <div class="user-label">RANK</div>
                <div class="user-val" id="rankDisplay">-</div>
            </div>
        </div>

        <div class="timer-container">
            <div class="timer-label">TEMPO DE FOCO ABSOLUTO</div>
            <div class="main-timer" id="timerDisplay">00:00:00</div>
            <div class="timer-unit">HORAS : MIN : SEG</div>
        </div>

        <div class="xp-box">
            <div class="xp-header">
                <span>MENTALIDADE (XP)</span>
                <span id="xpText">0 / 500</span>
            </div>
            <div class="xp-track"><div class="xp-fill" id="xpBar"></div></div>
        </div>

        <div class="btn-grid">
            <button id="btnClaim" class="btn-action btn-claim" disabled onclick="claimBonus()">
                RESGATAR NEURO-XP (+100)
                <div style="font-size:0.6rem; margin-top:5px; opacity:0.7;">DISPON√çVEL A CADA 24H</div>
            </button>

            <button id="btnReset" class="btn-action btn-fail" onclick="failProtocol()">
                ‚ö†Ô∏è RELATAR FALHA / RECA√çDA
                <div style="font-size:0.6rem; margin-top:5px; opacity:0.7;">REINICIA O CONTADOR</div>
            </button>
        </div>
    </div>

    <div id="screen-shop" class="screen">
        <div class="header">
            <div class="user-label">ARSENAL</div>
            <div class="user-val">BIO-HACKING</div>
        </div>
        
        <div class="shop-grid">
            <div class="shop-item" onclick="openLink('https://amazon.com.br/kindle')">
                <span class="shop-icon">üìö</span>
                <span class="shop-name">KINDLE (LEITURA)</span>
            </div>
            <div class="shop-item" onclick="openLink('https://amazon.com.br/cafeina')">
                <span class="shop-icon">üíä</span>
                <span class="shop-name">NOOTR√ìPICOS</span>
            </div>
            <div class="shop-item" onclick="openLink('https://amazon.com.br/bloqueadorazul')">
                <span class="shop-icon">üëì</span>
                <span class="shop-name">√ìCULOS BLUE-LIGHT</span>
            </div>
            <div class="shop-item" onclick="openLink('https://amazon.com.br/fones')">
                <span class="shop-icon">üéß</span>
                <span class="shop-name">NOISE CANCELLING</span>
            </div>
        </div>
        
        <div style="text-align:center; margin-top:30px; border:1px dashed #333; padding:15px;">
            <div style="color:#666; font-size:0.7rem; margin-bottom:10px;">SUPORTE O DESENVOLVEDOR</div>
            <button class="btn-action btn-claim" onclick="openLink('https://otieu.com/4/10557860')">
                DOAR VISUALIZA√á√ÉO (AD)
            </button>
        </div>
    </div>

    <div id="screen-log" class="screen">
        <div class="header">
            <div class="user-label">BANCO DE DADOS</div>
            <div class="user-val">HIST√ìRICO</div>
        </div>
        <div id="logList">Carregando dados...</div>
        
        <button class="btn-action btn-fail" onclick="logout()" style="margin-top:30px; border-color:#333; color:#666;">
            DESCONECTAR SISTEMA
        </button>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="nav('focus', this)"><span class="nav-icon">‚óâ</span>FOCO</div>
        <div class="nav-item" onclick="nav('shop', this)"><span class="nav-icon">‚ö°</span>ARSENAL</div>
        <div class="nav-item" onclick="nav('log', this)"><span class="nav-icon">‚â°</span>LOGS</div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyANh5g4EathHhB0cY4he_CTmdyLUm_TFuE",
            authDomain: "shapecoin.firebaseapp.com",
            projectId: "shapecoin",
            storageBucket: "shapecoin.firebasestorage.app",
            messagingSenderId: "365582210645",
            appId: "1:365582210645:web:8bf24f3809815340be66dc"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            let currentUser = null;
            let lastResetTime = null; // Timestamp do √∫ltimo reset
            let timerInterval = null;

            // Remove SW antigo
            if(navigator.serviceWorker) navigator.serviceWorker.getRegistrations().then(r => r.forEach(i => i.unregister()));

            auth.onAuthStateChanged((user) => {
                if (!user) window.location.href = "index.html";
                else { currentUser = user; initProtocol(); }
            });

            // --- NAVEGA√á√ÉO ---
            window.nav = (id, el) => {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                document.getElementById('screen-' + id).classList.add('active');
                el.classList.add('active');
            }

            // --- SISTEMA DE RANKS (MENTAL) ---
            function getRank(xp) {
                if(xp < 500) return { t: "NOVI√áO", n: 500 };
                if(xp < 1500) return { t: "DISCIPLINADO", n: 1500 };
                if(xp < 3000) return { t: "ESTOICO", n: 3000 };
                if(xp < 6000) return { t: "SOBERANO", n: 6000 };
                return { t: "ILUMINADO", n: 10000 };
            }

            // --- CORE LOGIC ---
            function initProtocol() {
                db.collection("users").doc(currentUser.uid).onSnapshot(doc => {
                    if(doc.exists) {
                        const d = doc.data();
                        const xp = d.coins || 0; // Usando 'coins' como XP Mental
                        const rank = getRank(xp);
                        
                        document.getElementById('playerName').innerText = d.username || "USER_01";
                        document.getElementById('rankDisplay').innerText = rank.t;
                        
                        // XP Bar
                        const pct = Math.min((xp / rank.n) * 100, 100);
                        document.getElementById('xpBar').style.width = pct + "%";
                        document.getElementById('xpText').innerText = `${xp} / ${rank.n}`;

                        // Timer Logic
                        if(d.lastReset) {
                            lastResetTime = d.lastReset.toDate();
                        } else {
                            // Se nunca resetou, marca agora como inicio
                            lastResetTime = new Date();
                            db.collection("users").doc(currentUser.uid).update({ 
                                lastReset: firebase.firestore.FieldValue.serverTimestamp() 
                            });
                        }
                        
                        startTimer();
                        document.getElementById('loading').style.display = 'none';
                    } else {
                        db.collection("users").doc(currentUser.uid).set({
                            coins: 0, 
                            username: "INICIADO",
                            lastReset: firebase.firestore.FieldValue.serverTimestamp()
                        }, {merge:true});
                    }
                });

                // Carrega Logs
                db.collection("history").where("userId", "==", currentUser.uid).orderBy("date", "desc").limit(10).onSnapshot(snap => {
                    const list = document.getElementById('logList');
                    list.innerHTML = "";
                    snap.forEach(d => {
                        const val = d.data();
                        const date = val.date ? val.date.toDate().toLocaleDateString('pt-BR') : "-";
                        const cor = val.type.includes("FALHA") ? "#ff2a2a" : "#00ff9d";
                        list.innerHTML += `
                            <div class="log-entry" style="border-color:${cor}">
                                <div style="color:white; font-weight:bold;">${val.type}</div>
                                <div style="display:flex; justify-content:space-between;">
                                    <span>${date}</span>
                                    <span style="color:${cor}">${val.value > 0 ? '+' + val.value + ' XP' : 'RESET'}</span>
                                </div>
                            </div>`;
                    });
                });
            }

            function startTimer() {
                if(timerInterval) clearInterval(timerInterval);
                
                timerInterval = setInterval(() => {
                    if(!lastResetTime) return;
                    
                    const now = new Date();
                    const diff = now - lastResetTime; // milisegundos
                    
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const secs = Math.floor((diff % (1000 * 60)) / 1000);

                    // Formata√ß√£o com Zeros (01:05:09)
                    const hStr = hours.toString().padStart(2, '0');
                    const mStr = mins.toString().padStart(2, '0');
                    const sStr = secs.toString().padStart(2, '0');

                    document.getElementById('timerDisplay').innerText = `${hStr}:${mStr}:${sStr}`;

                    // L√≥gica do Bot√£o Claim (S√≥ libera ap√≥s 24h = 86400000ms)
                    // Para testes, vamos deixar 10 segundos (10000ms)
                    // Na vers√£o final mude 10000 para 86400000
                    const btnClaim = document.getElementById('btnClaim');
                    if(diff > 86400000) { 
                        btnClaim.disabled = false;
                        btnClaim.style.opacity = "1";
                    } else {
                        btnClaim.disabled = true;
                        btnClaim.style.opacity = "0.5";
                    }

                }, 1000);
            }

            // --- A√á√ïES DO USU√ÅRIO ---

            // 1. FALHA (REINICIAR) - Onde entra o Ad Punitivo
            window.failProtocol = async () => {
                if(!confirm("CONFIRMAR FALHA DE PROTOCOLO?\nIsso vai zerar seu contador e exibir um an√∫ncio punitivo.")) return;
                
                // Abre o Ad (Puni√ß√£o)
                window.open('https://otieu.com/4/10557860', '_blank');

                const btn = document.getElementById('btnReset');
                btn.innerText = "REINICIANDO SISTEMA...";
                
                try {
                    // Reseta o Tempo no Banco
                    await db.collection("users").doc(currentUser.uid).update({
                        lastReset: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Registra a Vergonha no Hist√≥rico
                    await db.collection("history").add({
                        userId: currentUser.uid,
                        type: "‚ö†Ô∏è FALHA DE DISCIPLINA",
                        value: 0,
                        date: firebase.firestore.FieldValue.serverTimestamp()
                    });

                } catch(e) { console.error(e); }
                
                btn.innerText = "‚ö†Ô∏è RELATAR FALHA / RECA√çDA";
            }

            // 2. RECOMPENSA (24H)
            window.claimBonus = async () => {
                const btn = document.getElementById('btnClaim');
                
                // Abre Ad (Recompensa)
                window.open('https://otieu.com/4/10557860', '_blank');

                btn.innerText = "SINTONIZANDO...";
                btn.disabled = true;

                try {
                    // D√° XP
                    await db.collection("users").doc(currentUser.uid).update({
                        coins: firebase.firestore.FieldValue.increment(100),
                        // Opcional: Se quiser resetar o timer a cada 24h para for√ßar novo ciclo, descomente abaixo:
                        // lastReset: firebase.firestore.FieldValue.serverTimestamp() 
                    });

                    await db.collection("history").add({
                        userId: currentUser.uid,
                        type: "‚úÖ CICLO 24H COMPLETO",
                        value: 100,
                        date: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    alert("XP ADICIONADO. MANTENHA O FOCO.");

                } catch(e) { console.error(e); }

                btn.innerText = "RESGATAR NEURO-XP (+100)";
            }

            window.openLink = (url) => window.open(url, '_blank');
            window.logout = () => auth.signOut().then(() => window.location.reload());

        } catch(e) { alert("ERRO: " + e.message); }
    </script>
</body>
</html>

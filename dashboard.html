<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SYSTEM - Player</title>
    
    <meta name="theme-color" content="#00ff9d">
    <link rel="manifest" href="manifest.json">

    <style>
        /* TEMA "THE SYSTEM" */
        :root { 
            --primary: #00ff9d; 
            --danger: #ff3333; 
            --gold: #ffd700;
            --bg: #000000; 
            --panel: #0a0a0a; 
            --border: #1a1a1a; 
        }
        
        body { 
            background-color: var(--bg); color: white; 
            font-family: 'Courier New', monospace; 
            margin: 0; padding: 20px; padding-bottom: 80px;
        }
        
        /* HEADER */
        .player-header { border-bottom: 1px solid var(--primary); padding-bottom: 15px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-end; }
        .player-name { font-size: 0.9rem; color: #666; letter-spacing: 2px; text-transform: uppercase; }
        .player-rank { font-size: 2.5rem; font-weight: bold; color: var(--primary); line-height: 1; text-shadow: 0 0 10px rgba(0, 255, 157, 0.3); }
        .rank-label { font-size: 0.8rem; color: var(--primary); text-align: right; letter-spacing: 3px; }

        /* XP BAR */
        .xp-section { margin-bottom: 40px; }
        .xp-info { display: flex; justify-content: space-between; font-size: 0.7rem; color: #888; margin-bottom: 5px; }
        .xp-bar-container { width: 100%; height: 6px; background: #111; border: 1px solid #333; }
        .xp-bar-fill { height: 100%; background: var(--primary); width: 0%; box-shadow: 0 0 8px var(--primary); transition: width 0.5s ease; }

        /* CARDS */
        .system-card { 
            background: rgba(255, 255, 255, 0.02); 
            border: 1px solid #333; 
            padding: 20px; margin-bottom: 20px; position: relative;
        }
        .card-title { color: var(--primary); font-size: 1rem; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }

        /* LOJA */
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .shop-item { 
            border: 1px solid #333; padding: 15px; text-align: center; cursor: pointer; transition: 0.2s;
            background: linear-gradient(180deg, #111, #000);
        }
        .shop-item:hover { border-color: var(--gold); transform: translateY(-2px); }
        .item-icon { font-size: 2rem; margin-bottom: 10px; display: block; }
        .item-name { font-size: 0.8rem; color: #ccc; font-weight: bold; display: block; margin-bottom: 5px; }
        .item-price { font-size: 0.7rem; color: var(--gold); }
        
        /* BOT√ïES */
        button { 
            width: 100%; background: transparent; color: var(--primary); 
            font-family: 'Courier New', monospace; font-weight: bold; 
            border: 1px solid var(--primary); padding: 15px; cursor: pointer; 
            text-transform: uppercase; font-size: 1rem; transition: all 0.2s;
        }
        button:hover { background: var(--primary); color: black; box-shadow: 0 0 15px var(--primary); }
        button:disabled { border-color: #333; color: #333; cursor: not-allowed; box-shadow: none; }

        /* MENU INFERIOR FIXO */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
            background: #000; border-top: 1px solid #333;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 100;
        }
        .nav-btn { color: #555; font-size: 1.5rem; cursor: pointer; }
        .nav-btn.active { color: var(--primary); text-shadow: 0 0 10px var(--primary); }

        /* MODAIS E TELAS */
        .screen { display: none; padding-bottom: 60px; }
        .screen.active { display: block; }
        
        /* LOADING */
        #loading { position: fixed; top:50%; left:50%; transform:translate(-50%, -50%); color: var(--primary); font-size: 0.8rem; letter-spacing: 2px; animation: blink 1s infinite; text-align: center; width: 100%;}
        @keyframes blink { 0% {opacity:1;} 50% {opacity:0.3;} 100% {opacity:1;} }
        
        #error-msg { display: none; color: red; font-size: 0.7rem; margin-top: 20px; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

    <div id="loading">
        CONECTANDO AO SISTEMA...
        <div id="error-msg"></div>
    </div>

    <div id="screen-home" class="screen active">
        
        <div class="player-header">
            <div>
                <div class="player-name">CA√áADOR</div>
                <div id="playerName" style="font-weight:bold; font-size:1.1rem; color:white;">...</div>
            </div>
            <div>
                <div class="player-rank" id="rankDisplay">E</div>
                <div class="rank-label">RANK</div>
            </div>
        </div>

        <div class="xp-section">
            <div class="xp-info">
                <span>N√çVEL DE PODER</span>
                <span id="xpText">0 / 1000</span>
            </div>
            <div class="xp-bar-container">
                <div class="xp-bar-fill" id="xpBar"></div>
            </div>
        </div>

        <div class="system-card" style="border-color: var(--primary);">
            <div class="card-title">‚ö† Miss√£o Di√°ria</div>
            <p style="color:#aaa; font-size:0.8rem; margin-bottom:20px;">
                "Aquele que n√£o treina, n√£o evolui."<br>
                Objetivo: Realizar o treino completo de hoje.
            </p>
            <button id="btnComplete">COMPLETAR (+100 XP)</button>
        </div>

        <div class="system-card" style="border-color: var(--gold);">
            <div class="card-title" style="color:var(--gold)">‚ö° B√™n√ß√£o do Sistema</div>
            <p style="color:#aaa; font-size:0.8rem; margin-bottom:20px;">
                Receba energia extra assistindo a uma mensagem.
            </p>
            <button id="btnBuff" style="border-color:var(--gold); color:var(--gold)">RESGATAR (+20 XP)</button>
        </div>

    </div>

    <div id="screen-shop" class="screen">
        <h2 style="color:white; text-align:center; margin-bottom:30px; letter-spacing:2px;">MERCADOR</h2>
        
        <div class="shop-grid">
            <div class="shop-item" onclick="abrirLink('https://amazon.com.br/creatina')">
                <span class="item-icon">üß™</span>
                <span class="item-name">Po√ß√£o de For√ßa</span>
                <span class="item-price">R$ 89,90</span>
            </div>
            <div class="shop-item" onclick="abrirLink('https://amazon.com.br/halteres')">
                <span class="item-icon">‚öñÔ∏è</span>
                <span class="item-name">Pesos de Ferro</span>
                <span class="item-price">R$ 120,00</span>
            </div>
            <div class="shop-item" onclick="abrirLink('https://amazon.com.br/whey')">
                <span class="item-icon">ü•©</span>
                <span class="item-name">Ra√ß√£o de Elite</span>
                <span class="item-price">R$ 150,00</span>
            </div>
            <div class="shop-item" onclick="alert('Em breve.')">
                <span class="item-icon">üíé</span>
                <span class="item-name">Apoiar Criador</span>
                <span class="item-price">Doa√ß√£o</span>
            </div>
        </div>
        
        <p style="text-align:center; color:#444; font-size:0.7rem; margin-top:20px;">
            *Itens fornecidos por mercadores externos.
        </p>
    </div>

    <div id="screen-profile" class="screen">
        <div class="system-card">
            <div class="card-title">DADOS DO CA√áADOR</div>
            <input type="text" id="inputName" placeholder="Alterar Nome" style="width:100%; padding:10px; background:#111; border:1px solid #333; color:white; margin-bottom:10px;">
            <button onclick="salvarPerfil()">ATUALIZAR REGISTRO</button>
        </div>
        
        <div class="system-card" style="border-color:var(--danger)">
            <button onclick="sair()" style="border-color:var(--danger); color:var(--danger)">DESLOGAR DO SISTEMA</button>
        </div>
        
        <div style="margin-top:20px; font-size:0.7rem; color:#444; font-family:monospace;">
            LOG RECENTE:<br>
            <div id="logFeed">Carregando dados...</div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-btn active" onclick="mudarTela('home', this)">üè†</div>
        <div class="nav-btn" onclick="mudarTela('shop', this)">üõí</div>
        <div class="nav-btn" onclick="mudarTela('profile', this)">üë§</div>
    </div>

    <script>
        // Captura erros para mostrar na tela (Anti-Travamento)
        window.onerror = function(msg) {
            document.getElementById('error-msg').style.display = 'block';
            document.getElementById('error-msg').innerText = "ERRO: " + msg;
        };

        const firebaseConfig = {
            apiKey: "AIzaSyANh5g4EathHhB0cY4he_CTmdyLUm_TFuE",
            authDomain: "shapecoin.firebaseapp.com",
            projectId: "shapecoin",
            storageBucket: "shapecoin.firebasestorage.app",
            messagingSenderId: "365582210645",
            appId: "1:365582210645:web:8bf24f3809815340be66dc"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            let currentUser = null;

            // Remove Service Workers antigos que podem estar travando
            if(navigator.serviceWorker) { navigator.serviceWorker.getRegistrations().then(r => r.forEach(i => i.unregister())); }

            auth.onAuthStateChanged((user) => {
                if (!user) window.location.href = "index.html";
                else { currentUser = user; carregarSistema(); }
            });

            // NAVEGA√á√ÉO
            window.mudarTela = (telaId, btn) => {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('screen-' + telaId).classList.add('active');
                btn.classList.add('active');
            }

            window.abrirLink = (url) => {
                if(url.includes('amazon')) alert("Aqui abrir√° seu link da Amazon!"); 
                else window.open(url, '_blank');
            }

            // SISTEMA DE RANKS
            function calcularRank(xp) {
                if(xp < 1000) return { rank: "E", next: 1000 };
                if(xp < 3000) return { rank: "D", next: 3000 };
                if(xp < 6000) return { rank: "C", next: 6000 };
                if(xp < 10000) return { rank: "B", next: 10000 };
                if(xp < 20000) return { rank: "A", next: 20000 };
                return { rank: "S", next: 50000 };
            }

            function carregarSistema() {
                // 1. Carrega Perfil (Simples)
                db.collection("users").doc(currentUser.uid).onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        const xp = data.coins || 0;
                        const nome = data.username || "Desconhecido";

                        document.getElementById('playerName').innerText = nome;
                        document.getElementById('inputName').value = nome;

                        const info = calcularRank(xp);
                        document.getElementById('rankDisplay').innerText = info.rank;
                        
                        const pct = Math.min((xp / info.next) * 100, 100);
                        document.getElementById('xpBar').style.width = pct + "%";
                        document.getElementById('xpText').innerText = `${xp} / ${info.next}`;

                        // DESTRAVAMENTO: Remove tela de carregamento assim que pegar os dados b√°sicos
                        document.getElementById('loading').style.display = 'none';
                    } else {
                        // Cria perfil se n√£o existir
                        db.collection("users").doc(currentUser.uid).set({ coins: 0 }, { merge: true });
                    }
                });

                // 2. Carrega Logs (CORRIGIDO: Sem ordena√ß√£o no banco para n√£o travar)
                db.collection("history")
                  .where("userId", "==", currentUser.uid)
                  .limit(10) // Traz os √∫ltimos 10 (desordenados)
                  .onSnapshot(snap => {
                    const div = document.getElementById('logFeed');
                    div.innerHTML = "";
                    
                    let logs = [];
                    snap.forEach(d => logs.push(d.data()));
                    
                    // Ordena AQUI no celular (evita erro de √≠ndice no banco)
                    logs.sort((a,b) => (b.date?.toMillis() || 0) - (a.date?.toMillis() || 0));

                    logs.forEach(d => {
                        const val = d.value;
                        const type = d.type;
                        div.innerHTML += `<div style="margin-bottom:5px; border-left:2px solid #333; padding-left:5px;">${type}: <span style="color:var(--primary)">+${val} XP</span></div>`;
                    });
                });
            }

            // A√á√ïES
            document.getElementById('btnComplete').addEventListener('click', async () => {
                const btn = document.getElementById('btnComplete');
                btn.disabled = true; btn.innerText = "VERIFICANDO...";
                
                try {
                    await db.collection("history").add({
                        userId: currentUser.uid, type: "Miss√£o Di√°ria", value: 100,
                        date: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    await db.collection("users").doc(currentUser.uid).update({ coins: firebase.firestore.FieldValue.increment(100) });
                    alert("MISS√ÉO CUMPRIDA! +100 XP");
                } catch(e) { console.log(e); }
                
                btn.disabled = false; btn.innerText = "COMPLETAR (+100 XP)";
            });

            document.getElementById('btnBuff').addEventListener('click', async () => {
                const btn = document.getElementById('btnBuff');
                window.open('https://otieu.com/4/10557860', '_blank');

                btn.disabled = true; btn.innerText = "ABSORVENDO...";

                try {
                    await db.collection("history").add({
                        userId: currentUser.uid, type: "B√™n√ß√£o do Sistema", value: 20,
                        date: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    await db.collection("users").doc(currentUser.uid).update({ coins: firebase.firestore.FieldValue.increment(20) });
                    setTimeout(() => { alert("PODER AUMENTADO! +20 XP"); }, 2000);
                } catch(e) { console.log(e); }

                setTimeout(() => { btn.disabled = false; btn.innerText = "RESGATAR (+20 XP)"; }, 15000);
            });

            window.salvarPerfil = async () => {
                const nome = document.getElementById('inputName').value;
                if(nome) await db.collection("users").doc(currentUser.uid).set({ username: nome }, { merge: true });
                alert("REGISTRO ATUALIZADO");
            }

            window.sair = () => auth.signOut().then(() => window.location.reload());

        } catch(e) {
            document.getElementById('error-msg').innerText = "ERRO FATAL: " + e.message;
        }
    </script>
</body>
</html>

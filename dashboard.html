<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOCO - Painel</title>
    
    <meta name="theme-color" content="#00ff9d">
    <link rel="manifest" href="manifest.json">

    <style>
        /* TEMA FOCO PREMIUM */
        :root { --primary: #00ff9d; --gold: #ffd700; --bg: #050505; --card-bg: #111111; --border: #333; }
        
        body { 
            background-color: var(--bg); color: white; font-family: sans-serif; 
            margin: 0; padding: 20px; padding-bottom: 120px; 
        }
        
        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .user-info { cursor: pointer; }
        .user-info h2 { margin: 0; font-size: 1.4rem; color: var(--primary); }
        .coin-badge { background: var(--gold); color: black; padding: 5px 15px; border-radius: 20px; font-weight: bold; }

        /* N√çVEL */
        .level-section { margin-bottom: 30px; text-align: center; }
        .level-badge { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px; color: #888; display: block; margin-bottom: 5px;}
        .level-number { font-size: 2.5rem; font-weight: 900; margin: 0; line-height: 1; }
        .progress-container { width: 100%; background: #222; height: 8px; border-radius: 10px; margin-top: 15px; overflow: hidden; border: 1px solid #333; }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s ease-in-out; box-shadow: 0 0 10px var(--primary); }

        /* CART√ïES */
        .card { background-color: var(--card-bg); border: 1px solid var(--border); padding: 25px; border-radius: 20px; margin-bottom: 20px; max-width: 600px; margin-left: auto; margin-right: auto; }
        h3 { color: #fff; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 2px; border-bottom: 1px solid var(--border); padding-bottom: 12px; margin-top: 0; }

        /* BOT√ïES & INPUTS */
        button { width: 100%; background: var(--primary); color: #000; font-weight: 800; border: none; padding: 18px; border-radius: 12px; cursor: pointer; text-transform: uppercase; margin-top: 10px; }
        button:disabled { opacity: 0.5; }
        input { width: 100%; padding: 16px; margin: 10px 0; background: #222; border: 1px solid #333; color: white; border-radius: 10px; box-sizing: border-box; }

        /* HIST√ìRICO (PRIVADO) */
        .feed-post { 
            background: #111; border-bottom: 1px solid #222; 
            padding: 15px 10px; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .feed-post:last-child { border-bottom: none; }
        .post-date { color: #888; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
        .post-value { color: var(--gold); font-weight: bold; font-size: 1rem; }

        /* ADS */
        .ad-container { margin: 20px 0; text-align: center; min-height: 10px; }

        /* BANNER FIXO RODAP√â */
        .sticky-banner { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 450px; background: #1a1a1a; border: 1px solid #333; border-radius: 50px; padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.8); z-index: 999; }
        
        #error-log { display: none; color: #ff5555; text-align: center; border: 1px solid #ff5555; padding: 10px; margin-top: 20px; font-size: 12px; border-radius: 10px; background: rgba(255,0,0,0.1); }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

    <div class="header">
        <div class="user-info" onclick="toggleMenu()">
            <h2 id="displayUsername">... ‚öôÔ∏è</h2>
        </div>
        <div class="coin-badge">üíé <span id="coinBalance">0</span></div>
    </div>

    <div class="level-section">
        <span class="level-badge" id="levelTitle">Carregando...</span>
        <h1 class="level-number" id="levelNum">-</h1>
        <div class="progress-container">
            <div class="progress-bar" id="levelProgress"></div>
        </div>
        <p style="font-size: 0.7rem; color: #555; margin-top: 8px;">Faltam <span id="pointsToNext">...</span> FC para evoluir</p>
    </div>

    <div class="ad-container">
        </div>

    <div class="card" id="cardIdentity" style="display: none;">
        <h3>Configura√ß√µes</h3>
        <input type="text" id="username" placeholder="Seu @usuario">
        <div style="display: flex; gap: 10px;">
            <input type="text" id="weight" placeholder="Peso (kg)">
            <input type="text" id="height" placeholder="Altura (cm)">
        </div>
        <button id="btnSalvar">Salvar Dados</button>
        <p style="text-align: center; color: red; cursor: pointer; margin-top: 20px;" onclick="auth.signOut().then(()=>location.reload())">Sair da Conta</p>
    </div>

    <div class="card" style="border-color: var(--primary);">
        <h3 style="color: var(--primary);">Check-in Di√°rio</h3>
        <button id="btnTreinar">CONFIRMAR PRESEN√áA (+50 FC)</button>
    </div>

    <div class="card" style="padding: 10px;">
        <h3 style="margin: 15px;">Meu Hist√≥rico</h3>
        <div id="focoFeed">
            <p style="text-align: center; color: #444;">Carregando...</p>
        </div>
    </div>

    <div id="error-log"></div>

    <div class="sticky-banner" onclick="window.open('https://google.com', '_blank')">
        <span style="color: #fff; font-size: 0.8rem; font-weight: bold;">üî• Creatina em Promo√ß√£o</span>
        <div style="background: var(--primary); color: #000; padding: 5px 15px; border-radius: 20px; font-weight: 800; font-size: 0.7rem;">VER</div>
    </div>

    <script>
        // --- 1. COMANDO DE LIMPEZA (DESTRO√ìI O ROB√î TRAVADO) ---
        if(window.navigator && navigator.serviceWorker) {
            navigator.serviceWorker.getRegistrations()
            .then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister(); // Tchau, rob√¥!
                    console.log("Service Worker Desativado com Sucesso.");
                }
            });
        }

        // --- 2. CAPTURA DE ERROS (Pra voc√™ ver se der ruim) ---
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('error-log').style.display = 'block';
            document.getElementById('error-log').innerText = "Sistema: " + message;
        };

        const firebaseConfig = {
            apiKey: "AIzaSyANh5g4EathHhB0cY4he_CTmdyLUm_TFuE",
            authDomain: "shapecoin.firebaseapp.com",
            projectId: "shapecoin",
            storageBucket: "shapecoin.firebasestorage.app",
            messagingSenderId: "365582210645",
            appId: "1:365582210645:web:8bf24f3809815340be66dc"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            let currentUser = null;

            auth.onAuthStateChanged((user) => {
                if (!user) window.location.href = "index.html";
                else { currentUser = user; carregarDados(); }
            });

            // L√≥gica de N√≠vel
            function atualizarNivel(coins) {
                const pontosPorNivel = 1000; 
                const level = Math.floor(coins / pontosPorNivel) + 1;
                const progress = ((coins % pontosPorNivel) / pontosPorNivel) * 100;
                
                document.getElementById('levelNum').innerText = level;
                document.getElementById('levelProgress').style.width = progress + "%";
                document.getElementById('pointsToNext').innerText = pontosPorNivel - (coins % pontosPorNivel);
                
                const patentes = ["Iniciante", "Focado", "Atleta", "Brabo", "Elite", "Mestre", "Lenda"];
                document.getElementById('levelTitle').innerText = patentes[Math.min(level - 1, patentes.length - 1)];
            }

            // Salvar Perfil
            document.getElementById('btnSalvar').addEventListener('click', async () => {
                const btn = document.getElementById('btnSalvar');
                const user = document.getElementById('username').value.trim();
                if(!user) return alert("Preencha o nome!");
                
                btn.disabled = true;
                await db.collection("users").doc(currentUser.uid).set({
                    username: user.replace('@', ''),
                    weight: document.getElementById('weight').value,
                    height: document.getElementById('height').value
                }, { merge: true });
                
                alert("Salvo!");
                btn.disabled = false;
                toggleMenu();
            });

            // Bot√£o Treinar
            document.getElementById('btnTreinar').addEventListener('click', async () => {
                const btn = document.getElementById('btnTreinar');
                const displayUser = document.getElementById('displayUsername').innerText;
                
                if(displayUser.includes("Configurar") || displayUser.includes("...")) {
                    toggleMenu();
                    return alert("Aguarde carregar ou configure seu perfil!");
                }

                btn.disabled = true;
                btn.innerText = "REGISTRANDO...";

                try {
                    const docUser = await db.collection("users").doc(currentUser.uid).get();
                    const myName = docUser.data().username || "Atleta";

                    await db.collection("history").add({
                        userId: currentUser.uid,
                        username: myName,
                        type: "Check-in",
                        value: 50,
                        date: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    await db.collection("users").doc(currentUser.uid).update({
                        coins: firebase.firestore.FieldValue.increment(50)
                    });

                    alert("CHECK-IN FEITO!");
                } catch(e) { alert("Erro ao salvar: " + e.message); }
                
                btn.disabled = false;
                btn.innerText = "CONFIRMAR PRESEN√áA (+50 FC)";
            });

            // Carregar Dados (O Cora√ß√£o do App)
            function carregarDados() {
                // 1. Dados do Usu√°rio
                db.collection("users").doc(currentUser.uid).onSnapshot(doc => {
                    if (doc.exists) {
                        const d = doc.data();
                        const coins = d.coins || 0;
                        document.getElementById('coinBalance').innerText = coins.toLocaleString();
                        document.getElementById('displayUsername').innerText = d.username ? "@" + d.username + " ‚öôÔ∏è" : "Configurar Perfil ‚öôÔ∏è";
                        
                        if(d.username) document.getElementById('username').value = d.username;
                        if(d.weight) document.getElementById('weight').value = d.weight;
                        if(d.height) document.getElementById('height').value = d.height;

                        atualizarNivel(coins);
                    } else {
                        // Cria perfil vazio se n√£o existir para destravar
                        db.collection("users").doc(currentUser.uid).set({ coins: 0 }, { merge: true });
                    }
                });

                // 2. Hist√≥rico (Corre√ß√£o de √çndice: Ordena√ß√£o no Cliente)
                db.collection("history")
                  .where("userId", "==", currentUser.uid)
                  .limit(20)
                  .onSnapshot(snap => {
                    const div = document.getElementById('focoFeed');
                    div.innerHTML = "";
                    
                    if(snap.empty) { 
                        div.innerHTML = "<p style='text-align:center; color:#555;'>Nenhum hist√≥rico.</p>"; 
                        return; 
                    }

                    // Pega os dados e ordena AQUI no celular, n√£o no banco (evita erro de √≠ndice)
                    let docs = [];
                    snap.forEach(doc => docs.push(doc.data()));
                    docs.sort((a, b) => (b.date ? b.date.toMillis() : 0) - (a.date ? a.date.toMillis() : 0));

                    docs.forEach(d => {
                        let dataStr = "Hoje";
                        if(d.date) {
                            const dateObj = d.date.toDate();
                            const dia = dateObj.getDate().toString().padStart(2, '0');
                            const mes = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                            const hora = dateObj.getHours().toString().padStart(2, '0');
                            const min = dateObj.getMinutes().toString().padStart(2, '0');
                            dataStr = `${dia}/${mes} - ${hora}:${min}`;
                        }

                        div.innerHTML += `
                            <div class="feed-post">
                                <div class="post-date">
                                    <span>üìÖ</span>
                                    <span>${dataStr}</span>
                                </div>
                                <span class="post-value">+${d.value} FC</span>
                            </div>`;
                    });
                });
            }

            window.toggleMenu = function() {
                const m = document.getElementById('cardIdentity');
                m.style.display = (m.style.display === "none") ? "block" : "none";
            }

        } catch (e) {
            alert("Erro Fatal: " + e.message);
        }

        // --- 3. AN√öNCIO SEGURO (Carrega por √∫ltimo) ---
        window.onload = function() {
            setTimeout(function() {
                var s = document.createElement('script');
                s.dataset.zone = '10556905';
                s.src = 'https://gizokraijaw.net/vignette.min.js';
                document.body.appendChild(s);
            }, 3000); // 3 segundos de atraso para garantir que o app carregou
        };
    </script>
</body>
</html>
